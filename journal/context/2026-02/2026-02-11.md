## 7:13:26 PM CST - Context Capture

## Pre-commit Hook Development Session (2026-02-11)

### What We Built
Refactored the pre-commit verification hook (`pre-commit-hook.sh`) in claude-config. This is a Claude Code PreToolUse hook on Bash that gates `git commit` commands on security checks.

### Key Bugs Found and Fixed

1. **API crash from invalid Unicode**: `git grep` scanning third-party vendor files (`.obsidian/plugins/dataview/main.js`) found minified JS with invalid Unicode surrogates. This output was stuffed raw into the hook's JSON deny response, breaking Claude API JSON serialization and causing a crash loop. Fixed with line truncation (200 chars) in `security-check.sh` and output sanitization + 4KB cap in `pre-commit-hook.sh`.

2. **`.console-allow` only applied to console.log check**: The debugger and `.only` checks had hardcoded `:!node_modules` only. Refactored to shared `SKIP_PATHS` array used by ALL security checks. Renamed to `.verify-skip` (with `.console-allow` backwards compatibility).

3. **Regex didn't match `git -C <path> commit`**: The hook regex `git\s+commit` only matched `git commit` directly. Claude Code frequently uses `git -C /path/to/repo commit` when working in other directories. The `-C` flag between `git` and `commit` caused the regex to miss entirely, silently skipping verification. Fixed regex to `(^|\s|&&\s*|;\s*)git\s+(-[a-zA-Z]\s+\S+\s+)*commit\b`.

4. **sed `\s` not POSIX**: The `-C` path extraction used `sed 's/-C\s*//'` but sed doesn't understand `\s`. This left a leading space in the path, causing `cd` to fail with "No such file or directory" even though the path was correct. Fixed to `sed 's/^-C[[:space:]]*//'`.

5. **Success messages invisible**: Tried stderr (`>&2`) — Claude Code doesn't surface it. Tried JSON allow decision with `permissionDecisionReason` — Claude Code silently swallows allow decisions. Conclusion: Claude Code only surfaces hook output on deny. Silent success is the expected behavior.

### Design Decisions Made

- **Decision 7: Hook scoped to git diff** — Security checks in the hook should only scan staged files. Prevents scanning vendor files. Not yet implemented but captured in PRD.
- **Decision 8: Fix-and-retry is emergent** — When hook blocks a commit (deny), Claude reads the error, fixes the issue, retries. This IS the retry loop. No explicit orchestration needed.
- **Decision 5 updated**: Skill is for ad-hoc full-codebase verification. Hook is diff-scoped, deterministic commit gate.
- **`.verify-skip` replaces `.console-allow`** — Applies to ALL security checks, not just console.log. Error messages direct AI to create this file for vendor/third-party code.

### What's Still Outstanding
- Diff-scoping (Decision 7): Hook should scope lint and security checks to staged files only
- Milestone 1 not fully closed until diff-scoping is done
- PRD Milestones 2-4 still pending (Testing Decision Guide, CLAUDE.md templates, README)

### Architecture Insight
Claude Code PreToolUse hooks: only deny decisions produce visible output. Allow decisions are silent. This is by design — you don't want noise on every Bash command. The hook works when it blocks; absence of blocking = success.

═══════════════════════════════════════

